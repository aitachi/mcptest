<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent-MCPç³»ç»Ÿå…³é”®ä»£ç å®ç°è¯¦è§£</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #3498db, #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .section {
            background: rgba(255,255,255,0.95);
            margin-bottom: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .section-header {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .section-header .icon {
            margin-right: 15px;
            font-size: 1.2em;
        }
        
        .section-content {
            padding: 25px;
        }
        
        .code-section {
            background: #2d3748;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .code-header {
            background: #4a5568;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .file-path {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            font-family: monospace;
        }
        
        .code-content {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            overflow-x: auto;
            font-family: 'Courier New', Monaco, monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .line-number {
            color: #a0aec0;
            margin-right: 15px;
            user-select: none;
        }
        
        .keyword {
            color: #9f7efe;
            font-weight: bold;
        }
        
        .string {
            color: #68d391;
        }
        
        .comment {
            color: #a0aec0;
            font-style: italic;
        }
        
        .function {
            color: #fbb6ce;
        }
        
        .variable {
            color: #90cdf4;
        }
        
        .highlight-line {
            background: rgba(255, 255, 0, 0.1);
            border-left: 3px solid #ffd700;
            padding-left: 17px;
            margin-left: -20px;
        }
        
        .flow-diagram {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
        }
        
        .flow-step {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .flow-step::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .flow-step:hover::before {
            left: 100%;
        }
        
        .step-number {
            background: rgba(255,255,255,0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 20px;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        
        .step-description {
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .mechanism-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .mechanism-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .mechanism-title {
            color: #2c3e50;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .mechanism-title .icon {
            margin-right: 10px;
            font-size: 1.2em;
            color: #3498db;
        }
        
        .code-explanation {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .explanation-title {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        th {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e3f2fd;
        }
        
        .priority-badge {
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .priority-1 { background: #e74c3c; }
        .priority-2 { background: #f39c12; }
        .priority-3 { background: #f1c40f; }
        .priority-4 { background: #27ae60; }
        .priority-5 { background: #3498db; }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .code-content {
                font-size: 12px;
            }
            
            .flow-step {
                flex-direction: column;
                text-align: center;
            }
            
            .step-number {
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ” Agent-MCPç³»ç»Ÿå…³é”®ä»£ç å®ç°è¯¦è§£</h1>
            <p>æ·±å…¥åˆ†ææ¯ä¸ªå…³é”®æœºåˆ¶çš„å…·ä½“æºç å®ç°</p>
        </div>

        <!-- LLMåˆ†æä¸æ‰§è¡Œè®¡åˆ’ç”Ÿæˆ -->
        <div class="section">
            <div class="section-header">
                <span class="icon">ğŸ§ </span>
                LLMåˆ†æç”¨æˆ·æŸ¥è¯¢ â†’ é€‰æ‹©åˆé€‚åŠŸèƒ½ â†’ æŒ‰ä¼˜å…ˆçº§æ’åº â†’ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
            </div>
            <div class="section-content">
                <div class="mechanism-card">
                    <div class="mechanism-title">
                        <span class="icon">ğŸ“‹</span>
                        å®ç°æ–‡ä»¶ï¼šagent/core.py - process_queryæ–¹æ³•
                    </div>
                    
                    <div class="code-section">
                        <div class="code-header">
                            <span>æ ¸å¿ƒæµç¨‹ä»£ç </span>
                            <span class="file-path">agent/core.py</span>
                        </div>
                        <div class="code-content">
<span class="line-number">34</span><span class="keyword">async def</span> <span class="function">process_query</span>(<span class="variable">self</span>, <span class="variable">query</span>: <span class="keyword">str</span>) -> Dict[<span class="keyword">str</span>, Any]:
<span class="line-number">35</span>    <span class="comment"># æ­¥éª¤1: æ¥æ”¶ç”¨æˆ·æŸ¥è¯¢</span>
<span class="line-number">36</span>    logger.info(<span class="string">f"ğŸ¯ Agentæ¥æ”¶åˆ°ç”¨æˆ·æŸ¥è¯¢: {query}"</span>)
<span class="line-number">37</span>    
<span class="line-number">38</span>    <span class="comment"># æ­¥éª¤2: è·å–MCPæœåŠ¡å™¨å¯ç”¨åŠŸèƒ½åˆ—è¡¨</span>
<span class="line-number">39</span><span class="highlight-line">    <span class="variable">available_functions</span> = <span class="variable">self</span>.<span class="variable">mcp_server</span>.<span class="function">get_available_functions</span>()</span>
<span class="line-number">40</span>    logger.info(<span class="string">f"ğŸ“¦ è·å–åˆ° {len(available_functions)} ä¸ªå¯ç”¨åŠŸèƒ½"</span>)
<span class="line-number">41</span>    
<span class="line-number">42</span>    <span class="comment"># æ­¥éª¤3: è°ƒç”¨å¤§æ¨¡å‹è¿›è¡Œä»»åŠ¡åˆ†æå’Œæ‰§è¡Œè®¡åˆ’ç”Ÿæˆ</span>
<span class="line-number">43</span><span class="highlight-line">    <span class="variable">task_analysis</span> = <span class="keyword">await</span> <span class="variable">self</span>.<span class="variable">llm_client</span>.<span class="function">analyze_task</span>(<span class="variable">query</span>, <span class="variable">available_functions</span>)</span>
<span class="line-number">44</span>    
<span class="line-number">45</span>    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable">task_analysis</span>.<span class="function">get</span>(<span class="string">"steps"</span>):
<span class="line-number">46</span>        <span class="keyword">return</span> {<span class="string">"success"</span>: <span class="keyword">False</span>, <span class="string">"message"</span>: <span class="string">"å¤§æ¨¡å‹æ— æ³•ç”Ÿæˆæ‰§è¡Œè®¡åˆ’"</span>}
<span class="line-number">47</span>    
<span class="line-number">48</span>    <span class="variable">steps</span> = <span class="variable">task_analysis</span>[<span class="string">"steps"</span>]  <span class="comment"># è·å–æŒ‰ä¼˜å…ˆçº§æ’åºçš„æ‰§è¡Œæ­¥éª¤</span>
<span class="line-number">49</span>    <span class="variable">reasoning</span> = <span class="variable">task_analysis</span>.<span class="function">get</span>(<span class="string">"reasoning"</span>, <span class="string">""</span>)
<span class="line-number">50</span>    
<span class="line-number">51</span>    <span class="comment"># æ­¥éª¤4: æ‰§è¡Œä»»åŠ¡è®¡åˆ’</span>
<span class="line-number">52</span><span class="highlight-line">    <span class="variable">results</span> = <span class="keyword">await</span> <span class="variable">self</span>.<span class="variable">executor</span>.<span class="function">execute_with_llm_guidance</span>(<span class="variable">query</span>, <span class="variable">steps</span>)</span>
                        </div>
                    </div>
                    
                    <div class="code-explanation">
                        <div class="explanation-title">ğŸ” ä»£ç é€»è¾‘è§£æ</div>
                        <p><strong>ç¬¬39è¡Œï¼š</strong>ä»MCPæœåŠ¡å™¨è·å–æ‰€æœ‰å¯ç”¨åŠŸèƒ½åŠå…¶ä¼˜å…ˆçº§ä¿¡æ¯</p>
                        <p><strong>ç¬¬43è¡Œï¼š</strong>å°†ç”¨æˆ·æŸ¥è¯¢å’ŒåŠŸèƒ½åˆ—è¡¨å‘é€ç»™LLMè¿›è¡Œæ™ºèƒ½åˆ†æ</p>
                        <p><strong>ç¬¬52è¡Œï¼š</strong>å°†LLMç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’ä¼ é€’ç»™ä»»åŠ¡æ‰§è¡Œå™¨</p>
                    </div>
                </div>

                <div class="mechanism-card">
                    <div class="mechanism-title">
                        <span class="icon">ğŸ¯</span>
                        LLMä»»åŠ¡åˆ†æå®ç°ï¼šllm_client.py - analyze_taskæ–¹æ³•
                    </div>
                    
                    <div class="code-section">
                        <div class="code-header">
                            <span>LLMåˆ†æä¸ä¼˜å…ˆçº§æ’åº</span>
                            <span class="file-path">agent/llm_client.py</span>
                        </div>
                        <div class="code-content">
<span class="line-number">95</span><span class="keyword">async def</span> <span class="function">analyze_task</span>(<span class="variable">self</span>, <span class="variable">query</span>: <span class="keyword">str</span>, <span class="variable">available_functions</span>: List[Dict]) -> Dict[<span class="keyword">str</span>, Any]:
<span class="line-number">96</span>    <span class="comment"># æ„å»ºåŠŸèƒ½ä¿¡æ¯ï¼ŒåŒ…å«ä¼˜å…ˆçº§</span>
<span class="line-number">97</span><span class="highlight-line">    <span class="variable">functions_info</span> = <span class="string">"\n"</span>.<span class="function">join</span>([</span>
<span class="line-number">98</span><span class="highlight-line">        <span class="string">f"- {func['name']}: {func['description']} (ä¼˜å…ˆçº§: {func['priority']}, ç±»åˆ«: {func['category']})"</span></span>
<span class="line-number">99</span><span class="highlight-line">        <span class="keyword">for</span> <span class="variable">func</span> <span class="keyword">in</span> <span class="variable">available_functions</span></span>
<span class="line-number">100</span><span class="highlight-line">    ])</span>
<span class="line-number">101</span>    
<span class="line-number">102</span>    <span class="comment"># æ„å»ºæç¤ºè¯ï¼ŒæŒ‡å¯¼LLMæŒ‰ä¼˜å…ˆçº§é€‰æ‹©åŠŸèƒ½</span>
<span class="line-number">103</span>    <span class="variable">prompt</span> = <span class="string">f"""
<span class="line-number">104</span>ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½ä»»åŠ¡åˆ†æåŠ©æ‰‹ã€‚æ ¹æ®ç”¨æˆ·æŸ¥è¯¢ï¼Œä»å¯ç”¨åŠŸèƒ½ä¸­é€‰æ‹©åˆé€‚çš„åŠŸèƒ½ï¼Œå¹¶ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ã€‚
<span class="line-number">105</span>
<span class="line-number">106</span>å¯ç”¨åŠŸèƒ½:
<span class="line-number">107</span>{functions_info}
<span class="line-number">108</span>
<span class="line-number">109</span>ç”¨æˆ·æŸ¥è¯¢: {query}
<span class="line-number">110</span>
<span class="line-number">111</span>è¯·åˆ†æç”¨æˆ·æŸ¥è¯¢ï¼Œé€‰æ‹©åˆé€‚çš„åŠŸèƒ½ï¼Œå¹¶æŒ‰é€»è¾‘é¡ºåºæ’åˆ—ã€‚
<span class="line-number">112</span>
<span class="line-number">113</span>æ³¨æ„ï¼š
<span class="line-number">114</span><span class="highlight-line">1. ä¼˜å…ˆé€‰æ‹©ä¼˜å…ˆçº§ä½çš„åŠŸèƒ½ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰</span>
<span class="line-number">115</span><span class="highlight-line">2. æŒ‰ç…§é€»è¾‘é¡ºåºæ’åˆ—åŠŸèƒ½ï¼šéªŒè¯->æŸ¥è¯¢/è¯»å–->å¤„ç†->åˆ†æ->å†™å…¥/å‘é€</span>
<span class="line-number">116</span>3. æ ¹æ®æŸ¥è¯¢å†…å®¹æ™ºèƒ½åŒ¹é…å‚æ•°
<span class="line-number">117</span>"""</span>
<span class="line-number">118</span>    
<span class="line-number">119</span>    <span class="variable">messages</span> = [{<span class="string">"role"</span>: <span class="string">"user"</span>, <span class="string">"content"</span>: <span class="variable">prompt</span>}]
<span class="line-number">120</span><span class="highlight-line">    <span class="variable">response</span> = <span class="keyword">await</span> <span class="variable">self</span>.<span class="function">chat_completion</span>(<span class="variable">messages</span>)</span>
<span class="line-number">121</span>    
<span class="line-number">122</span>    <span class="keyword">try</span>:
<span class="line-number">123</span><span class="highlight-line">        <span class="variable">result</span> = json.<span class="function">loads</span>(<span class="variable">response</span>)  <span class="comment"># è§£æLLMè¿”å›çš„JSONæ ¼å¼æ‰§è¡Œè®¡åˆ’</span></span>
<span class="line-number">124</span>        <span class="keyword">return</span> <span class="variable">result</span>
<span class="line-number">125</span>    <span class="keyword">except</span> Exception <span class="keyword">as</span> <span class="variable">e</span>:
<span class="line-number">126</span>        <span class="keyword">return</span> {<span class="string">"steps"</span>: [], <span class="string">"reasoning"</span>: <span class="string">"è§£æå¤±è´¥"</span>}
                        </div>
                    </div>
                    
                    <div class="code-explanation">
                        <div class="explanation-title">ğŸ” ä¼˜å…ˆçº§æ’åºæœºåˆ¶</div>
                        <p><strong>ç¬¬97-100è¡Œï¼š</strong>å°†æ‰€æœ‰åŠŸèƒ½åŠå…¶ä¼˜å…ˆçº§ä¿¡æ¯æ ¼å¼åŒ–ä¸ºæç¤ºè¯</p>
                        <p><strong>ç¬¬114-115è¡Œï¼š</strong>æ˜ç¡®æŒ‡ç¤ºLLMæŒ‰ä¼˜å…ˆçº§å’Œé€»è¾‘é¡ºåºæ’åˆ—åŠŸèƒ½</p>
                        <p><strong>ç¬¬123è¡Œï¼š</strong>è§£æLLMè¿”å›çš„JSONæ ¼å¼æ‰§è¡Œè®¡åˆ’</p>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ä¼˜å…ˆçº§</th>
                                <th>åŠŸèƒ½ç±»åˆ«</th>
                                <th>å…¸å‹åŠŸèƒ½</th>
                                <th>æ‰§è¡Œé€»è¾‘</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="priority-badge priority-1">1</span></td>
                                <td>æ•°æ®éªŒè¯</td>
                                <td>validate_data</td>
                                <td>é¦–å…ˆéªŒè¯è¾“å…¥æ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§</td>
                            </tr>
                            <tr>
                                <td><span class="priority-badge priority-2">2</span></td>
                                <td>æŸ¥è¯¢/è¯»å–</td>
                                <td>database_query, read_file</td>
                                <td>è·å–éœ€è¦å¤„ç†çš„æ•°æ®æº</td>
                            </tr>
                            <tr>
                                <td><span class="priority-badge priority-3">3</span></td>
                                <td>æ•°æ®å¤„ç†</td>
                                <td>process_data, http_request</td>
                                <td>å¯¹æ•°æ®è¿›è¡Œè½¬æ¢ã€æ ¼å¼åŒ–ç­‰å¤„ç†</td>
                            </tr>
                            <tr>
                                <td><span class="priority-badge priority-4">4</span></td>
                                <td>æ•°æ®åˆ†æ</td>
                                <td>analyze_data</td>
                                <td>å¯¹å¤„ç†åçš„æ•°æ®è¿›è¡Œæ·±åº¦åˆ†æ</td>
                            </tr>
                            <tr>
                                <td><span class="priority-badge priority-5">5+</span></td>
                                <td>å†™å…¥/é€šä¿¡</td>
                                <td>write_file, send_email, database_insert</td>
                                <td>å°†ç»“æœä¿å­˜æˆ–å‘é€ç»™å¤–éƒ¨ç³»ç»Ÿ</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- FIFOé˜Ÿåˆ—æœºåˆ¶ -->
        <div class="section">
            <div class="section-header">
                <span class="icon">ğŸ“‹</span>
                FIFOé˜Ÿåˆ—æœºåˆ¶ - å¦‚ä½•ç¡®ä¿æ­¥éª¤é¡ºåºæ‰§è¡Œ
            </div>
            <div class="section-content">
                <div class="mechanism-card">
                    <div class="mechanism-title">
                        <span class="icon">âš¡</span>
                        å®ç°æ–‡ä»¶ï¼šagent/executor.py - execute_with_llm_guidanceæ–¹æ³•
                    </div>
                    
                    <div class="code-section">
                        <div class="code-header">
                            <span>FIFOé˜Ÿåˆ—é¡ºåºæ‰§è¡Œæœºåˆ¶</span>
                            <span class="file-path">agent/executor.py</span>
                        </div>
                        <div class="code-content">
<span class="line-number">15</span><span class="keyword">async def</span> <span class="function">execute_with_llm_guidance</span>(<span class="variable">self</span>, <span class="variable">query</span>: <span class="keyword">str</span>, <span class="variable">steps</span>: List[Dict[<span class="keyword">str</span>, Any]]) -> List[Dict[<span class="keyword">str</span>, Any]]:
<span class="line-number">16</span>    <span class="variable">results</span> = []  <span class="comment"># å­˜å‚¨æ‰€æœ‰æ­¥éª¤æ‰§è¡Œç»“æœ</span>
<span class="line-number">17</span><span class="highlight-line">    <span class="variable">remaining_steps</span> = <span class="variable">steps</span>.<span class="function">copy</span>()  <span class="comment"># å¤åˆ¶æ­¥éª¤åˆ—è¡¨ï¼Œå½¢æˆFIFOé˜Ÿåˆ—</span></span>
<span class="line-number">18</span>    
<span class="line-number">19</span>    <span class="variable">step_counter</span> = 1
<span class="line-number">20</span><span class="highlight-line">    <span class="keyword">while</span> <span class="variable">remaining_steps</span>:  <span class="comment"># å…³é”®ï¼šå¾ªç¯ç›´åˆ°é˜Ÿåˆ—ä¸ºç©º</span></span>
<span class="line-number">21</span><span class="highlight-line">        <span class="variable">current_step</span> = <span class="variable">remaining_steps</span>[0]  <span class="comment"># æ€»æ˜¯æ‰§è¡Œé˜Ÿåˆ—ç¬¬ä¸€ä¸ªå…ƒç´ </span></span>
<span class="line-number">22</span>        
<span class="line-number">23</span>        logger.info(<span class="string">f"ğŸ“ æ‰§è¡Œæ­¥éª¤ {step_counter}: {current_step['function_name']}"</span>)
<span class="line-number">24</span>        
<span class="line-number">25</span>        <span class="comment"># æ‰§è¡Œå½“å‰æ­¥éª¤</span>
<span class="line-number">26</span>        <span class="variable">start_time</span> = time.<span class="function">time</span>()
<span class="line-number">27</span><span class="highlight-line">        <span class="variable">result</span> = <span class="keyword">await</span> <span class="variable">self</span>.<span class="variable">mcp_server</span>.<span class="function">execute_function</span>(</span>
<span class="line-number">28</span><span class="highlight-line">            <span class="variable">current_step</span>[<span class="string">'function_name'</span>],</span>
<span class="line-number">29</span><span class="highlight-line">            **<span class="variable">current_step</span>[<span class="string">'parameters'</span>]</span>
<span class="line-number">30</span><span class="highlight-line">        )</span>
<span class="line-number">31</span>        <span class="variable">end_time</span> = time.<span class="function">time</span>()
<span class="line-number">32</span>        
<span class="line-number">33</span>        <span class="comment"># è®°å½•æ­¥éª¤æ‰§è¡Œç»“æœ</span>
<span class="line-number">34</span><span class="highlight-line">        <span class="variable">step_result</span> = {</span>
<span class="line-number">35</span><span class="highlight-line">            <span class="string">"step"</span>: <span class="variable">step_counter</span>,</span>
<span class="line-number">36</span><span class="highlight-line">            <span class="string">"function_name"</span>: <span class="variable">current_step</span>[<span class="string">'function_name'</span>],</span>
<span class="line-number">37</span><span class="highlight-line">            <span class="string">"parameters"</span>: <span class="variable">current_step</span>[<span class="string">'parameters'</span>],</span>
<span class="line-number">38</span><span class="highlight-line">            <span class="string">"result"</span>: <span class="variable">result</span>,</span>
<span class="line-number">39</span><span class="highlight-line">            <span class="string">"execution_time"</span>: <span class="variable">end_time</span> - <span class="variable">start_time</span></span>
<span class="line-number">40</span><span class="highlight-line">        }</span>
<span class="line-number">41</span><span class="highlight-line">        <span class="variable">results</span>.<span class="function">append</span>(<span class="variable">step_result</span>)  <span class="comment"># è®°å½•æ‰§è¡Œç»“æœ</span></span>
<span class="line-number">42</span><span class="highlight-line">        <span class="variable">remaining_steps</span>.<span class="function">pop</span>(0)  <span class="comment"># ä»é˜Ÿåˆ—ç§»é™¤å·²å®Œæˆæ­¥éª¤</span></span>
<span class="line-number">43</span>        
<span class="line-number">44</span>        <span class="keyword">if</span> <span class="variable">remaining_steps</span>:  <span class="comment"># å¦‚æœè¿˜æœ‰å‰©ä½™æ­¥éª¤</span>
<span class="line-number">45</span>            <span class="comment"># å’¨è¯¢LLMå†³å®šä¸‹ä¸€æ­¥</span>
<span class="line-number">46</span><span class="highlight-line">            <span class="variable">decision</span> = <span class="keyword">await</span> <span class="variable">self</span>.<span class="variable">llm_client</span>.<span class="function">decide_next_step</span>(<span class="variable">query</span>, <span class="variable">results</span>, <span class="variable">remaining_steps</span>)</span>
<span class="line-number">47</span>            
<span class="line-number">48</span>            <span class="variable">action</span> = <span class="variable">decision</span>.<span class="function">get</span>(<span class="string">"action"</span>, <span class="string">"continue"</span>)
<span class="line-number">49</span>            <span class="keyword">if</span> <span class="variable">action</span> == <span class="string">"stop"</span>:
<span class="line-number">50</span>                <span class="keyword">break</span>
<span class="line-number">51</span>            <span class="keyword">elif</span> <span class="variable">action</span> == <span class="string">"modify"</span> <span class="keyword">and</span> <span class="variable">decision</span>.<span class="function">get</span>(<span class="string">"next_step"</span>):
<span class="line-number">52</span><span class="highlight-line">                <span class="variable">remaining_steps</span>[0] = <span class="variable">decision</span>[<span class="string">"next_step"</span>]  <span class="comment"># ä¿®æ”¹é˜Ÿåˆ—ç¬¬ä¸€ä¸ªå…ƒç´ </span></span>
<span class="line-number">53</span>        
<span class="line-number">54</span>        <span class="variable">step_counter</span> += 1
<span class="line-number">55</span>    
<span class="line-number">56</span><span class="highlight-line">    <span class="keyword">return</span> <span class="variable">results</span>  <span class="comment"># è¿”å›æ‰€æœ‰æ­¥éª¤æ‰§è¡Œç»“æœ</span></span>
                        </div>
                    </div>
                    
                    <div class="code-explanation">
                        <div class="explanation-title">ğŸ” FIFOé˜Ÿåˆ—æœºåˆ¶è§£æ</div>
                        <p><strong>ç¬¬17è¡Œï¼š</strong>å¤åˆ¶æ­¥éª¤åˆ—è¡¨å½¢æˆFIFOé˜Ÿåˆ—ï¼Œä¿æŒåŸå§‹è®¡åˆ’ä¸å˜</p>
                        <p><strong>ç¬¬20è¡Œï¼š</strong>whileå¾ªç¯ç¡®ä¿æ‰€æœ‰æ­¥éª¤éƒ½è¢«å¤„ç†</p>
                        <p><strong>ç¬¬21è¡Œï¼š</strong>æ€»æ˜¯æ‰§è¡Œremaining_steps[0]ï¼Œç¡®ä¿FIFOé¡ºåº</p>
                        <p><strong>ç¬¬42è¡Œï¼š</strong>æ‰§è¡Œå®Œæˆåç”¨pop(0)ç§»é™¤é˜Ÿåˆ—é¦–å…ƒç´ </p>
                        <p><strong>ç¬¬52è¡Œï¼š</strong>å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œåªä¿®æ”¹é˜Ÿåˆ—ä¸‹ä¸€ä¸ªå…ƒç´ </p>
                    </div>
                </div>

                <div class="flow-diagram">
                    <div class="flow-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">åˆå§‹åŒ–é˜Ÿåˆ—</div>
                            <div class="step-description">remaining_steps = [æ­¥éª¤1, æ­¥éª¤2, æ­¥éª¤3, æ­¥éª¤4]</div>
                        </div>
                    </div>
                    
                    <div class="flow-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">æ‰§è¡Œé˜Ÿåˆ—é¦–å…ƒç´ </div>
                            <div class="step-description">current_step = remaining_steps[0] â†’ æ‰§è¡Œæ­¥éª¤1</div>
                        </div>
                    </div>
                    
                    <div class="flow-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">ç§»é™¤å·²å®Œæˆæ­¥éª¤</div>
                            <div class="step-description">remaining_steps.pop(0) â†’ [æ­¥éª¤2, æ­¥éª¤3, æ­¥éª¤4]</div>
                        </div>
                    </div>
                    
                    <div class="flow-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <div class="step-title">å¾ªç¯ç»§ç»­</div>
                            <div class="step-description">é‡å¤è¿‡ç¨‹ï¼Œç›´åˆ°remaining_stepsä¸ºç©º</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤é—´é€šçŸ¥æœºåˆ¶ -->
        <div class="section">
            <div class="section-header">
                <span class="icon">ğŸ”„</span>
                æ­¥éª¤1å®Œæˆåå¦‚ä½•é€šçŸ¥æ‰§è¡Œæ­¥éª¤2
            </div>
            <div class="section-content">
                <div class="mechanism-card">
                    <div class="mechanism-title">
                        <span class="icon">ğŸ“</span>
                        é€šè¿‡results.append()è®°å½• + remaining_steps.pop(0)ç§»é™¤æœºåˆ¶
                    </div>
                    
                    <div class="code-section">
                        <div class="code-header">
                            <span>æ­¥éª¤å®Œæˆé€šçŸ¥æœºåˆ¶</span>
                            <span class="file-path">agent/executor.py</span>
                        </div>
                        <div class="code-content">
<span class="line-number">34</span>        <span class="comment"># ğŸ“ æ­¥éª¤1ï¼šè®°å½•å½“å‰æ­¥éª¤æ‰§è¡Œç»“æœ</span>
<span class="line-number">35</span><span class="highlight-line">        <span class="variable">step_result</span> = {</span>
<span class="line-number">36</span><span class="highlight-line">            <span class="string">"step"</span>: <span class="variable">step_counter</span>,                    <span class="comment"># æ­¥éª¤ç¼–å·</span></span>
<span class="line-number">37</span><span class="highlight-line">            <span class="string">"function_name"</span>: <span class="variable">current_step</span>[<span class="string">'function_name'</span>], <span class="comment"># æ‰§è¡Œçš„åŠŸèƒ½å</span></span>
<span class="line-number">38</span><span class="highlight-line">            <span class="string">"parameters"</span>: <span class="variable">current_step</span>[<span class="string">'parameters'</span>],     <span class="comment"># æ‰§è¡Œå‚æ•°</span></span>
<span class="line-number">39</span><span class="highlight-line">            <span class="string">"result"</span>: <span class="variable">result</span>,                        <span class="comment"># MCPæ‰§è¡Œç»“æœ</span></span>
<span class="line-number">40</span><span class="highlight-line">            <span class="string">"execution_time"</span>: <span class="variable">end_time</span> - <span class="variable">start_time</span>, <span class="comment"># æ‰§è¡Œè€—æ—¶</span></span>
<span class="line-number">41</span><span class="highlight-line">            <span class="string">"timestamp"</span>: time.<span class="function">time</span>()              <span class="comment"># æ‰§è¡Œæ—¶é—´æˆ³</span></span>
<span class="line-number">42</span><span class="highlight-line">        }</span>
<span class="line-number">43</span>        
<span class="line-number">44</span>        <span class="comment"># ğŸ“ æ­¥éª¤2ï¼šå°†ç»“æœæ·»åŠ åˆ°resultsåˆ—è¡¨ï¼ˆå®Œæˆé€šçŸ¥ï¼‰</span>
<span class="line-number">45</span><span class="highlight-line">        <span class="variable">results</span>.<span class="function">append</span>(<span class="variable">step_result</span>)  <span class="comment"># âœ… æ ‡è®°æ­¥éª¤1å·²å®Œæˆ</span></span>
<span class="line-number">46</span>        
<span class="line-number">47</span>        <span class="comment"># ğŸ“ æ­¥éª¤3ï¼šä»å¾…æ‰§è¡Œé˜Ÿåˆ—ç§»é™¤å·²å®Œæˆæ­¥éª¤</span>
<span class="line-number">48</span><span class="highlight-line">        <span class="variable">remaining_steps</span>.<span class="function">pop</span>(0)  <span class="comment"># âœ… æ­¥éª¤1å‡ºé˜Ÿï¼Œæ­¥éª¤2æˆä¸ºé˜Ÿé¦–</span></span>
<span class="line-number">49</span>        
<span class="line-number">50</span>        <span class="comment"># ğŸ“ æ­¥éª¤4ï¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¾…æ‰§è¡Œæ­¥éª¤</span>
<span class="line-number">51</span>        <span class="keyword">if</span> <span class="variable">remaining_steps</span>:  <span class="comment"># å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©º</span>
<span class="line-number">52</span>            <span class="comment"># ğŸ“ æ­¥éª¤5ï¼šå’¨è¯¢LLMå…³äºä¸‹ä¸€æ­¥çš„å†³ç­–</span>
<span class="line-number">53</span><span class="highlight-line">            <span class="variable">decision</span> = <span class="keyword">await</span> <span class="variable">self</span>.<span class="variable">llm_client</span>.<span class="function">decide_next_step</span>(</span>
<span class="line-number">54</span><span class="highlight-line">                <span class="variable">query</span>,           <span class="comment"># åŸå§‹ç”¨æˆ·æŸ¥è¯¢</span></span>
<span class="line-number">55</span><span class="highlight-line">                <span class="variable">results</span>,         <span class="comment"># å·²å®Œæˆæ­¥éª¤çš„æ‰§è¡Œå†å²</span></span>
<span class="line-number">56</span><span class="highlight-line">                <span class="variable">remaining_steps</span>  <span class="comment"># å‰©ä½™å¾…æ‰§è¡Œæ­¥éª¤</span></span>
<span class="line-number">57</span><span class="highlight-line">            )</span>
<span class="line-number">58</span>            
<span class="line-number">59</span>            <span class="comment"># ğŸ“ æ­¥éª¤6ï¼šæ ¹æ®LLMå†³ç­–è°ƒæ•´æ‰§è¡Œè®¡åˆ’</span>
<span class="line-number">60</span>            <span class="variable">action</span> = <span class="variable">decision</span>.<span class="function">get</span>(<span class="string">"action"</span>, <span class="string">"continue"</span>)
<span class="line-number">61</span>            <span class="keyword">if</span> <span class="variable">action</span> == <span class="string">"stop"</span>:
<span class="line-number">62</span>                <span class="keyword">break</span>  <span class="comment"># åœæ­¢æ‰§è¡Œ</span>
<span class="line-number">63</span>            <span class="keyword">elif</span> <span class="variable">action</span> == <span class="string">"modify"</span>:
<span class="line-number">64</span><span class="highlight-line">                <span class="variable">remaining_steps</span>[0] = <span class="variable">decision</span>[<span class="string">"next_step"</span>]  <span class="comment"># ä¿®æ”¹æ­¥éª¤2</span></span>
<span class="line-number">65</span>        
<span class="line-number">66</span>        <span class="comment"># ğŸ“ æ­¥éª¤7ï¼šå¾ªç¯å›åˆ°whileå¼€å§‹ï¼Œæ‰§è¡Œæ­¥éª¤2</span>
<span class="line-number">67</span>        <span class="variable">step_counter</span> += 1  <span class="comment"># æ­¥éª¤è®¡æ•°å™¨é€’å¢</span>
                        </div>
                    </div>
                    
                    <div class="code-explanation">
                        <div class="explanation-title">ğŸ” é€šçŸ¥æœºåˆ¶è¯¦è§£</div>
                        <p><strong>ç¬¬45è¡Œï¼š</strong>results.append()ä¸æ˜¯ç®€å•è®°å½•ï¼Œè€Œæ˜¯"å®Œæˆé€šçŸ¥"æœºåˆ¶</p>
                        <p><strong>ç¬¬48è¡Œï¼š</strong>remaining_steps.pop(0)ç§»é™¤å·²å®Œæˆæ­¥éª¤ï¼Œä½¿æ­¥éª¤2æˆä¸ºé˜Ÿé¦–</p>
                        <p><strong>ç¬¬53-57è¡Œï¼š</strong>LLMèƒ½è®¿é—®å®Œæ•´çš„æ‰§è¡Œå†å²ï¼Œåšå‡ºæ™ºèƒ½å†³ç­–</p>
                        <p><strong>å¾ªç¯ç‰¹æ€§ï¼š</strong>whileå¾ªç¯è‡ªåŠ¨å›åˆ°ç¬¬20è¡Œï¼Œæ‰§è¡Œæ–°çš„é˜Ÿé¦–å…ƒç´ </p>
                    </div>
                </div>

                <div class="mechanism-card">
                    <div class="mechanism-title">
                        <span class="icon">ğŸ§ </span>
                        LLMå†³ç­–æœºåˆ¶ï¼šllm_client.py - decide_next_stepæ–¹æ³•
                    </div>
                    
                    <div class="code-section">
                        <div class="code-header">
                            <span>LLMæ™ºèƒ½å†³ç­–å®ç°</span>
                            <span class="file-path">agent/llm_client.py</span>
                        </div>
                        <div class="code-content">
<span class="line-number">161</span><span class="keyword">async def</span> <span class="function">decide_next_step</span>(<span class="variable">self</span>, <span class="variable">query</span>: <span class="keyword">str</span>, <span class="variable">execution_history</span>: List[Dict], <span class="variable">remaining_steps</span>: List[Dict]) -> Dict[<span class="keyword">str</span>, Any]:
<span class="line-number">162</span>    <span class="comment"># æ„å»ºæ‰§è¡Œå†å²ä¿¡æ¯</span>
<span class="line-number">163</span><span class="highlight-line">    <span class="variable">history_text</span> = <span class="string">"\n"</span>.<span class="function">join</span>([</span>
<span class="line-number">164</span><span class="highlight-line">        <span class="string">f"æ­¥éª¤{i + 1}: {step['function_name']} - {'æˆåŠŸ' if step['result']['success'] else 'å¤±è´¥'}"</span></span>
<span class="line-number">165</span><span class="highlight-line">        <span class="keyword">for</span> <span class="variable">i</span>, <span class="variable">step</span> <span class="keyword">in</span> <span class="function">enumerate</span>(<span class="variable">execution_history</span>)</span>
<span class="line-number">166</span><span class="highlight-line">    ])</span>
<span class="line-number">167</span>    
<span class="line-number">168</span>    <span class="comment"># æ„å»ºå‰©ä½™æ­¥éª¤ä¿¡æ¯</span>
<span class="line-number">169</span><span class="highlight-line">    <span class="variable">remaining_text</span> = <span class="string">"\n"</span>.<span class="function">join</span>([</span>
<span class="line-number">170</span><span class="highlight-line">        <span class="string">f"- {step['function_name']}: {step['parameters']}"</span></span>
<span class="line-number">171</span><span class="highlight-line">        <span class="keyword">for</span> <span class="variable">step</span> <span class="keyword">in</span> <span class="variable">remaining_steps</span></span>
<span class="line-number">172</span><span class="highlight-line">    ])</span>
<span class="line-number">173</span>    
<span class="line-number">174</span>    <span class="variable">prompt</span> = <span class="string">f"""
<span class="line-number">175</span>æ ¹æ®æ‰§è¡Œå†å²å’Œå‰©ä½™æ­¥éª¤ï¼Œå†³å®šä¸‹ä¸€æ­¥æ“ä½œã€‚
<span class="line-number">176</span>
<span class="line-number">177</span>åŸå§‹æŸ¥è¯¢: {query}
<span class="line-number">178</span>
<span class="line-number">179</span><span class="highlight-line">å·²æ‰§è¡Œæ­¥éª¤:
<span class="line-number">180</span>{history_text}</span>
<span class="line-number">181</span>
<span class="line-number">182</span><span class="highlight-line">å‰©ä½™æ­¥éª¤:
<span class="line-number">183</span>{remaining_text}</span>
<span class="line-number">184</span>
<span class="line-number">185</span>è¯·è¿”å›å†³ç­–ï¼šcontinue/modify/stop
<span class="line-number">186</span>"""</span>
<span class="line-number">187</span>    
<span class="line-number">188</span><span class="highlight-line">    <span class="variable">response</span> = <span class="keyword">await</span> <span class="variable">self</span>.<span class="function">chat_completion</span>([{<span class="string">"role"</span>: <span class="string">"user"</span>, <span class="string">"content"</span>: <span class="variable">prompt</span>}])</span>
<span class="line-number">189</span><span class="highlight-line">    <span class="keyword">return</span> json.<span class="function">loads</span>(<span class="variable">response</span>)</span>
                        </div>
                    </div>
                    
                    <div class="code-explanation">
                        <div class="explanation-title">ğŸ” æ™ºèƒ½å†³ç­–æœºåˆ¶</div>
                        <p><strong>ç¬¬163-166è¡Œï¼š</strong>å°†æ‰€æœ‰å·²æ‰§è¡Œæ­¥éª¤åŠå…¶ç»“æœæ ¼å¼åŒ–ä¸ºæ–‡æœ¬</p>
                        <p><strong>ç¬¬169-172è¡Œï¼š</strong>å°†å‰©ä½™å¾…æ‰§è¡Œæ­¥éª¤æ ¼å¼åŒ–ä¸ºæ–‡æœ¬</p>
                        <p><strong>ç¬¬188è¡Œï¼š</strong>LLMåŸºäºå®Œæ•´ä¸Šä¸‹æ–‡åšå‡ºæ™ºèƒ½å†³ç­–</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœ€ç»ˆç»“æœé€šä¿¡ -->
        <div class="section">
            <div class="section-header">
                <span class="icon">ğŸ“¡</span>
                æœ€åä¸€æ­¥å¦‚ä½•é€šä¿¡ç»™Agent - å®Œæ•´ç»“æœä¼ é€’æœºåˆ¶
            </div>
            <div class="section-content">
                <div class="mechanism-card">
                    <div class="mechanism-title">
                        <span class="icon">ğŸ”„</span>
                        executor.py â†’ core.py ç»“æœä¼ é€’é“¾è·¯
                    </div>
                    
                    <div class="code-section">
                        <div class="code-header">
                            <span>TaskExecutorè¿”å›å®Œæ•´ç»“æœ</span>
                            <span class="file-path">agent/executor.py</span>
                        </div>
                        <div class="code-content">
<span class="line-number">95</span>    <span class="comment"># ğŸ‰ æ‰€æœ‰æ­¥éª¤æ‰§è¡Œå®Œæ¯•ï¼Œé€€å‡ºwhileå¾ªç¯</span>
<span class="line-number">96</span>    logger.info(<span class="string">f"ğŸ‰ ä»»åŠ¡è®¡åˆ’æ‰§è¡Œå®Œæˆï¼å…±æ‰§è¡Œ {len(results)} ä¸ªæ­¥éª¤"</span>)
<span class="line-number">97</span>    
<span class="line-number">98</span>    <span class="comment"># ğŸ“Š è¿”å›æ‰€æœ‰æ­¥éª¤çš„æ‰§è¡Œç»“æœç»™Agent</span>
<span class="line-number">99</span><span class="highlight-line">    <span class="keyword">return</span> <span class="variable">results</span>  <span class="comment"># List[Dict] åŒ…å«æ‰€æœ‰æ­¥éª¤è¯¦ç»†ä¿¡æ¯</span></span>
<span class="line-number">100</span>
<span class="line-number">101</span>    <span class="comment"># resultsç»“æ„ç¤ºä¾‹ï¼š</span>
<span class="line-number">102</span>    <span class="comment"># [</span>
<span class="line-number">103</span>    <span class="comment">#   {</span>
<span class="line-number">104</span>    <span class="comment">#     "step": 1,</span>
<span class="line-number">105</span>    <span class="comment">#     "function_name": "validate_data",</span>
<span class="line-number">106</span>    <span class="comment">#     "parameters": {...},</span>
<span class="line-number">107</span>    <span class="comment">#     "result": {"success": True, "result": {...}},</span>
<span class="line-number">108</span>    <span class="comment">#     "execution_time": 0.51,</span>
<span class="line-number">109</span>    <span class="comment">#     "timestamp": 1748266688.734</span>
<span class="line-number">110</span>    <span class="comment">#   },</span>
<span class="line-number">111</span>    <span class="comment">#   ... å…¶ä»–æ­¥éª¤</span>
<span class="line-number">112</span>    <span class="comment"># ]</span>
                        </div>
                    </div>
                    
                    <div class="code-section">
                        <div class="code-header">
                            <span>Agentæ¥æ”¶å¹¶ç”Ÿæˆæœ€ç»ˆæ±‡æ€»</span>
                            <span class="file-path">agent/core.py</span>
                        </div>
                        <div class="code-content">
<span class="line-number">52</span>    <span class="comment"># ğŸ“¥ æ¥æ”¶TaskExecutorè¿”å›çš„æ‰€æœ‰æ­¥éª¤ç»“æœ</span>
<span class="line-number">53</span><span class="highlight-line">    <span class="variable">results</span> = <span class="keyword">await</span> <span class="variable">self</span>.<span class="variable">executor</span>.<span class="function">execute_with_llm_guidance</span>(<span class="variable">query</span>, <span class="variable">steps</span>)</span>
<span class="line-number">54</span>    
<span class="line-number">55</span>    <span class="comment"># ğŸ“Š ç”Ÿæˆæ‰§è¡Œæ€»ç»“ç»Ÿè®¡</span>
<span class="line-number">56</span><span class="highlight-line">    <span class="variable">summary</span> = <span class="variable">self</span>.<span class="function">_generate_summary</span>(<span class="variable">query</span>, <span class="variable">steps</span>, <span class="variable">results</span>)</span>
<span class="line-number">57</span>    
<span class="line-number">58</span>    <span class="comment"># ğŸ¯ è¿”å›å®Œæ•´çš„å¤„ç†ç»“æœ</span>
<span class="line-number">59</span><span class="highlight-line">    <span class="keyword">return</span> {</span>
<span class="line-number">60</span><span class="highlight-line">        <span class="string">"success"</span>: <span class="keyword">True</span>,</span>
<span class="line-number">61</span><span class="highlight-line">        <span class="string">"query"</span>: <span class="variable">query</span>,              <span class="comment"># åŸå§‹ç”¨æˆ·æŸ¥è¯¢</span></span>
<span class="line-number">62</span><span class="highlight-line">        <span class="string">"steps"</span>: <span class="variable">steps</span>,              <span class="comment"># LLMç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’</span></span>
<span class="line-number">63</span><span class="highlight-line">        <span class="string">"reasoning"</span>: <span class="variable">reasoning</span>,      <span class="comment"># LLMåˆ†æç†ç”±</span></span>
<span class="line-number">64</span><span class="highlight-line">        <span class="string">"results"</span>: <span class="variable">results</span>,          <span class="comment"># æ‰€æœ‰æ­¥éª¤æ‰§è¡Œç»“æœ</span></span>
<span class="line-number">65</span><span class="highlight-line">        <span class="string">"summary"</span>: <span class="variable">summary</span>           <span class="comment"># æ‰§è¡Œç»Ÿè®¡æ±‡æ€»</span></span>
<span class="line-number">66</span><span class="highlight-line">    }</span>
                        </div>
                    </div>
                    
                    <div class="code-section">
                        <div class="code-header">
                            <span>ç»Ÿè®¡æ±‡æ€»ç”Ÿæˆé€»è¾‘</span>
                            <span class="file-path">agent/core.py</span>
                        </div>
                        <div class="code-content">
<span class="line-number">68</span><span class="keyword">def</span> <span class="function">_generate_summary</span>(<span class="variable">self</span>, <span class="variable">query</span>: <span class="keyword">str</span>, <span class="variable">steps</span>: List[Dict], <span class="variable">results</span>: List[Dict]) -> Dict[<span class="keyword">str</span>, Any]:
<span class="line-number">69</span>    <span class="comment"># ğŸ“Š ç»Ÿè®¡æˆåŠŸå’Œå¤±è´¥çš„æ­¥éª¤</span>
<span class="line-number">70</span><span class="highlight-line">    <span class="variable">successful_steps</span> = [<span class="variable">r</span> <span class="keyword">for</span> <span class="variable">r</span> <span class="keyword">in</span> <span class="variable">results</span> <span class="keyword">if</span> <span class="variable">r</span>[<span class="string">"result"</span>].<span class="function">get</span>(<span class="string">"success"</span>)]</span>
<span class="line-number">71</span><span class="highlight-line">    <span class="variable">failed_steps</span> = [<span class="variable">r</span> <span class="keyword">for</span> <span class="variable">r</span> <span class="keyword">in</span> <span class="variable">results</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable">r</span>[<span class="string">"result"</span>].<span class="function">get</span>(<span class="string">"success"</span>)]</span>
<span class="line-number">72</span>    
<span class="line-number">73</span>    <span class="comment"># â±ï¸ è®¡ç®—æ€»æ‰§è¡Œæ—¶é—´</span>
<span class="line-number">74</span><span class="highlight-line">    <span class="variable">total_time</span> = <span class="function">sum</span>(<span class="variable">r</span>[<span class="string">"execution_time"</span>] <span class="keyword">for</span> <span class="variable">r</span> <span class="keyword">in</span> <span class="variable">results</span>)</span>
<span class="line-number">75</span>    
<span class="line-number">76</span>    <span class="comment"># ğŸ“ˆ ç”Ÿæˆè¯¦ç»†ç»Ÿè®¡ä¿¡æ¯</span>
<span class="line-number">77</span><span class="highlight-line">    <span class="variable">summary</span> = {</span>
<span class="line-number">78</span><span class="highlight-line">        <span class="string">"total_planned_steps"</span>: <span class="function">len</span>(<span class="variable">steps</span>),</span>
<span class="line-number">79</span><span class="highlight-line">        <span class="string">"total_executed_steps"</span>: <span class="function">len</span>(<span class="variable">results</span>),</span>
<span class="line-number">80</span><span class="highlight-line">        <span class="string">"successful_steps"</span>: <span class="function">len</span>(<span class="variable">successful_steps</span>),</span>
<span class="line-number">81</span><span class="highlight-line">        <span class="string">"failed_steps"</span>: <span class="function">len</span>(<span class="variable">failed_steps</span>),</span>
<span class="line-number">82</span><span class="highlight-line">        <span class="string">"total_execution_time"</span>: <span class="variable">total_time</span>,</span>
<span class="line-number">83</span><span class="highlight-line">        <span class="string">"average_step_time"</span>: <span class="variable">total_time</span> / <span class="function">len</span>(<span class="variable">results</span>) <span class="keyword">if</span> <span class="variable">results</span> <span class="keyword">else</span> 0,</span>
<span class="line-number">84</span><span class="highlight-line">        <span class="string">"success_rate"</span>: <span class="function">len</span>(<span class="variable">successful_steps</span>) / <span class="function">len</span>(<span class="variable">results</span>) <span class="keyword">if</span> <span class="variable">results</span> <span class="keyword">else</span> 0,</span>
<span class="line-number">85</span><span class="highlight-line">        <span class="string">"status"</span>: <span class="string">"completed"</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable">failed_steps</span> <span class="keyword">else</span> <span class="string">"partial_success"</span></span>
<span class="line-number">86</span><span class="highlight-line">    }</span>
<span class="line-number">87</span>    
<span class="line-number">88</span><span class="highlight-line">    <span class="keyword">return</span> <span class="variable">summary</span></span>
                        </div>
                    </div>
                    
                    <div class="code-explanation">
                        <div class="explanation-title">ğŸ” ç»“æœé€šä¿¡æœºåˆ¶è¯¦è§£</div>
                        <p><strong>æ‰§è¡Œå®Œæˆä¿¡å·ï¼š</strong>whileå¾ªç¯è‡ªç„¶ç»“æŸè¡¨ç¤ºæ‰€æœ‰æ­¥éª¤å®Œæˆ</p>
                        <p><strong>ç»“æœä¼ é€’ï¼š</strong>é€šè¿‡returnè¯­å¥å°†å®Œæ•´resultsè¿”å›ç»™Agent</p>
                        <p><strong>ç»Ÿè®¡ç”Ÿæˆï¼š</strong>AgentåŸºäºresultsç”ŸæˆæˆåŠŸç‡ã€è€—æ—¶ç­‰ç»Ÿè®¡ä¿¡æ¯</p>
                        <p><strong>æœ€ç»ˆè¾“å‡ºï¼š</strong>åŒ…å«åŸå§‹æŸ¥è¯¢ã€æ‰§è¡Œè®¡åˆ’ã€ç»“æœã€ç»Ÿè®¡çš„å®Œæ•´æ•°æ®ç»“æ„</p>
                    </div>
                </div>

                <div class="flow-diagram">
                    <div class="flow-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">æœ€åä¸€æ­¥æ‰§è¡Œå®Œæˆ</div>
                            <div class="step-description">step_resultè¿½åŠ åˆ°resultsï¼Œremaining_steps.pop(0)åé˜Ÿåˆ—ä¸ºç©º</div>
                        </div>
                    </div>
                    
                    <div class="flow-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">whileå¾ªç¯ç»“æŸ</div>
                            <div class="step-description">remaining_stepsä¸ºç©ºï¼Œwhileæ¡ä»¶ä¸ºFalseï¼Œå¾ªç¯è‡ªç„¶ç»“æŸ</div>
                        </div>
                    </div>
                    
                    <div class="flow-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">return results</div>
                            <div class="step-description">TaskExecutorå°†åŒ…å«æ‰€æœ‰æ­¥éª¤ä¿¡æ¯çš„resultsè¿”å›ç»™Agent</div>
                        </div>
                    </div>
                    
                    <div class="flow-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <div class="step-title">Agentç”Ÿæˆæœ€ç»ˆç»“æœ</div>
                            <div class="step-description">åŸºäºresultsç”Ÿæˆç»Ÿè®¡æ±‡æ€»ï¼Œè¿”å›å®Œæ•´çš„å¤„ç†ç»“æœ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»ç¨‹åºè°ƒç”¨é“¾ -->
        <div class="section">
            <div class="section-header">
                <span class="icon">ğŸ”—</span>
                å®Œæ•´è°ƒç”¨é“¾è·¯ï¼šmain.pyå…¥å£ç‚¹
            </div>
            <div class="section-content">
                <div class="mechanism-card">
                    <div class="mechanism-title">
                        <span class="icon">ğŸš€</span>
                        ç³»ç»Ÿå¯åŠ¨ä¸æµ‹è¯•æµç¨‹ï¼šmain.py
                    </div>
                    
                    <div class="code-section">
                        <div class="code-header">
                            <span>ä¸»ç¨‹åºè°ƒç”¨æµç¨‹</span>
                            <span class="file-path">main.py</span>
                        </div>
                        <div class="code-content">
<span class="line-number">6</span><span class="keyword">async def</span> <span class="function">main</span>():
<span class="line-number">7</span>    <span class="comment"># ğŸš€ æ­¥éª¤1ï¼šåˆå§‹åŒ–MCPæœåŠ¡å™¨</span>
<span class="line-number">8</span><span class="highlight-line">    <span class="variable">mcp_server</span> = MCPServer()</span>
<span class="line-number">9</span><span class="highlight-line">    <span class="keyword">await</span> <span class="variable">mcp_server</span>.<span class="function">start</span>()</span>
<span class="line-number">10</span>    
<span class="line-number">11</span>    <span class="comment"># ğŸ¤– æ­¥éª¤2ï¼šåˆå§‹åŒ–Agent</span>
<span class="line-number">12</span><span class="highlight-line">    <span class="variable">agent</span> = Agent(<span class="variable">mcp_server</span>)</span>
<span class="line-number">13</span>    
<span class="line-number">14</span>    <span class="comment"># ğŸ“‹ æ­¥éª¤3ï¼šè·å–å¹¶æ˜¾ç¤ºå¯ç”¨åŠŸèƒ½</span>
<span class="line-number">15</span>    <span class="variable">functions</span> = <span class="variable">mcp_server</span>.<span class="function">get_available_functions</span>()
<span class="line-number">16</span>    
<span class="line-number">17</span>    <span class="comment"># ğŸ” æ­¥éª¤4ï¼šæ‰§è¡Œæµ‹è¯•æŸ¥è¯¢</span>
<span class="line-number">18</span>    <span class="variable">test_queries</span> = [
<span class="line-number">19</span>        <span class="string">"éªŒè¯ç”¨æˆ·è¾“å…¥æ•°æ®ï¼Œå‘é€HTTPè¯·æ±‚è·å–å¤–éƒ¨æ•°æ®ï¼Œå¤„ç†åˆå¹¶åæ’å…¥æ•°æ®åº“"</span>,
<span class="line-number">20</span>        <span class="comment"># ... å…¶ä»–æµ‹è¯•æŸ¥è¯¢</span>
<span class="line-number">21</span>    ]
<span class="line-number">22</span>    
<span class="line-number">23</span>    <span class="keyword">for</span> <span class="variable">query</span> <span class="keyword">in</span> <span class="variable">test_queries</span>:
<span class="line-number">24</span>        <span class="comment"># ğŸ¯ å…³é”®è°ƒç”¨ï¼šAgentå¤„ç†æŸ¥è¯¢</span>
<span class="line-number">25</span><span class="highlight-line">        <span class="variable">result</span> = <span class="keyword">await</span> <span class="variable">agent</span>.<span class="function">process_query</span>(<span class="variable">query</span>)</span>
<span class="line-number">26</span>        
<span class="line-number">27</span>        <span class="comment"># ğŸ“Š æ˜¾ç¤ºæ‰§è¡Œç»“æœ</span>
<span class="line-number">28</span>        <span class="keyword">if</span> <span class="variable">result</span>[<span class="string">"success"</span>]:
<span class="line-number">29</span><span class="highlight-line">            <span class="variable">summary</span> = <span class="variable">result</span>[<span class="string">"summary"</span>]</span>
<span class="line-number">30</span>            <span class="function">print</span>(<span class="string">f"âœ… æˆåŠŸç‡: {summary['success_rate']:.1%}"</span>)
<span class="line-number">31</span>            <span class="function">print</span>(<span class="string">f"â±ï¸ æ€»è€—æ—¶: {summary['total_execution_time']:.2f}ç§’"</span>)
                        </div>
                    </div>
                    
                    <div class="code-explanation">
                        <div class="explanation-title">ğŸ” å®Œæ•´è°ƒç”¨é“¾è·¯</div>
                        <p><strong>main.py â†’ Agent.process_query() â†’ TaskExecutor.execute_with_llm_guidance() â†’ MCP.execute_function()</strong></p>
                        <p>æ¯ä¸ªç¯èŠ‚éƒ½æœ‰æ˜ç¡®çš„è¾“å…¥è¾“å‡ºï¼Œå½¢æˆå®Œæ•´çš„æ•°æ®æµ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ€»ç»“ -->
        <div class="section">
            <div class="section-header">
                <span class="icon">ğŸ“</span>
                å…³é”®æœºåˆ¶æ€»ç»“
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>æœºåˆ¶</th>
                                <th>å®ç°æ–‡ä»¶</th>
                                <th>å…³é”®ä»£ç </th>
                                <th>ä½œç”¨</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>LLMä»»åŠ¡åˆ†æ</td>
                                <td>llm_client.py</td>
                                <td>analyze_task()ç¬¬97-123è¡Œ</td>
                                <td>æ™ºèƒ½åˆ†æç”¨æˆ·æŸ¥è¯¢ï¼ŒæŒ‰ä¼˜å…ˆçº§ç”Ÿæˆæ‰§è¡Œè®¡åˆ’</td>
                            </tr>
                            <tr>
                                <td>FIFOé˜Ÿåˆ—æ‰§è¡Œ</td>
                                <td>executor.py</td>
                                <td>execute_with_llm_guidance()ç¬¬20-42è¡Œ</td>
                                <td>ç¡®ä¿æ­¥éª¤ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸è·³è¿‡ä¸é‡å¤</td>
                            </tr>
                            <tr>
                                <td>æ­¥éª¤å®Œæˆé€šçŸ¥</td>
                                <td>executor.py</td>
                                <td>ç¬¬41è¡Œresults.append() + ç¬¬42è¡Œpop(0)</td>
                                <td>æ ‡è®°æ­¥éª¤å®Œæˆï¼Œè§¦å‘ä¸‹ä¸€æ­¥æ‰§è¡Œ</td>
                            </tr>
                            <tr>
                                <td>LLMæ™ºèƒ½å†³ç­–</td>
                                <td>llm_client.py</td>
                                <td>decide_next_step()ç¬¬161-189è¡Œ</td>
                                <td>åŸºäºæ‰§è¡Œå†å²æ™ºèƒ½è°ƒæ•´åç»­æ­¥éª¤</td>
                            </tr>
                            <tr>
                                <td>ç»“æœæ±‡æ€»è¿”å›</td>
                                <td>core.py</td>
                                <td>process_query()ç¬¬53-66è¡Œ</td>
                                <td>ç”Ÿæˆå®Œæ•´çš„æ‰§è¡ŒæŠ¥å‘Šå’Œç»Ÿè®¡ä¿¡æ¯</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mechanism-card">
                    <div class="mechanism-title">
                        <span class="icon">âœ…</span>
                        ç³»ç»Ÿä¼˜åŠ¿
                    </div>
                    <ul>
                        <li>ğŸ§  <strong>æ™ºèƒ½ä»»åŠ¡è§„åˆ’ï¼š</strong>LLMæ ¹æ®åŠŸèƒ½ä¼˜å…ˆçº§å’Œç”¨æˆ·æŸ¥è¯¢ç”Ÿæˆæœ€ä¼˜æ‰§è¡Œè®¡åˆ’</li>
                        <li>ğŸ”„ <strong>åŠ¨æ€æ‰§è¡Œè°ƒæ•´ï¼š</strong>æ¯æ­¥å®ŒæˆåLLMå¯æ ¹æ®ç»“æœè°ƒæ•´åç»­æ­¥éª¤</li>
                        <li>ğŸ“‹ <strong>ä¸¥æ ¼é¡ºåºä¿è¯ï¼š</strong>FIFOé˜Ÿåˆ—æœºåˆ¶ç¡®ä¿æ­¥éª¤ä¸ä¼šè·³è¿‡æˆ–ä¹±åº</li>
                        <li>ğŸ“Š <strong>å®Œæ•´çŠ¶æ€è·Ÿè¸ªï¼š</strong>è¯¦ç»†è®°å½•æ¯æ­¥æ‰§è¡Œæƒ…å†µï¼Œæ”¯æŒé—®é¢˜è¯Šæ–­</li>
                        <li>ğŸ”§ <strong>æ¨¡å—åŒ–è®¾è®¡ï¼š</strong>å„ç»„ä»¶èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>